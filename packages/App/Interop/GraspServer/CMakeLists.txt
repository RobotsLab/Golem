###############################################################################
#
# Golem App/Interop/GraspServer application
#
###############################################################################

option(GOLEM_BUILD_APP_GRASP_SERVER "Build Interop GraspServer application" NO)
mark_as_advanced(GOLEM_BUILD_APP_GRASP_SERVER)

if(GOLEM_BUILD_APP_GRASP_SERVER)
	# EXTERN
	option(GOLEM_BUILD_APP_GRASP_SERVER_TEST "Build Interop GraspServer test without EXTERN" YES)
	mark_as_advanced(GOLEM_BUILD_APP_GRASP_SERVER_TEST)
	if(NOT GOLEM_BUILD_APP_GRASP_SERVER_TEST)
		SET(EXTERN_DIR "${GOLEM_PROJECT_PARENT}/extern" CACHE PATH "EXTERN directory")

		# OpenCV
		#FIND_PACKAGE(OpenCV REQUIRED)
	endif(NOT GOLEM_BUILD_APP_GRASP_SERVER_TEST)

	# Boost
	if (WIN32)
		ADD_DEFINITIONS(-DBOOST_ALL_NO_LIB)
		SET(Boost_USE_STATIC_LIBS ON)
		SET(Boost_ALL_DYN_LINK OFF)
	elseif (UNIX)
		#ADD_DEFINITIONS(-DBOOST_ALL_NO_LIB)
		#SET(Boost_USE_STATIC_LIBS OFF)
		#SET(Boost_ALL_DYN_LINK ON)
	endif ()
	FIND_PACKAGE(Boost COMPONENTS system)
	
	# PCL
	FIND_PACKAGE(PCL REQUIRED)
	list(REMOVE_ITEM PCL_LIBRARIES "vtkproj4") # PCL bug

	
	SET(PACKAGE_DIR "${PACKAGE_APP}/Interop/GraspServer")

	FILE(GLOB_RECURSE PACKAGE_SOURCES "${PACKAGE_DIR}/src/*.cpp")
	FILE(GLOB_RECURSE PACKAGE_HEADERS "${PACKAGE_DIR}/include/*.h")
	FILE(GLOB_RECURSE PACKAGE_FILES "${PACKAGE_DIR}/resources/*.xml")

	ADD_EXECUTABLE(GolemGraspServer ${PACKAGE_SOURCES} ${PACKAGE_HEADERS} ${PACKAGE_FILES})

	if (WIN32)
		TARGET_COMPILE_OPTIONS(GolemGraspServer PUBLIC /wd4996 /wd4005)
	elseif (UNIX)
		TARGET_COMPILE_OPTIONS(GolemGraspServer PUBLIC -Wno-invalid-offsetof)
	endif()

	if(NOT GOLEM_BUILD_APP_GRASP_SERVER_TEST)
		TARGET_COMPILE_DEFINITIONS(GolemGraspServer
			PUBLIC _EXTERN_LIB_=1
			#PUBLIC ${OPENCV_DEFINITIONS}
		)
	endif(NOT GOLEM_BUILD_APP_GRASP_SERVER_TEST)
	
	#TARGET_INCLUDE_DIRECTORIES(GolemGraspServer PUBLIC ${PACKAGE_DIR}/include ${GOLEM_PROJECT_PACKAGES}/App/UI/Grasp/include)
	TARGET_INCLUDE_DIRECTORIES(GolemGraspServer
		PUBLIC ${PACKAGE_DIR}/include
		PUBLIC ${GOLEM_PROJECT_PACKAGES}/App/UI/Grasp/include
		PUBLIC ${GOLEM_PROJECT_PACKAGES}/Interop/Interop/Core/include/Golem/Interop
		PUBLIC ${GOLEM_PROJECT_PACKAGES}/Interop/Interop/Contact/include/Golem/Interop
		PUBLIC ${GOLEM_PROJECT_PACKAGES}/Interop/Interop/PCL/include/Golem/Interop
		PUBLIC ${Boost_INCLUDE_DIRS}
		PUBLIC ${PCL_INCLUDE_DIRS}
	)
	if(NOT GOLEM_BUILD_APP_GRASP_SERVER_TEST)
		TARGET_INCLUDE_DIRECTORIES(GolemGraspServer
			#PUBLIC ${OPENCV_INCLUDE_DIRS}
			PUBLIC ${EXTERN_DIR}/include
		)
	endif(NOT GOLEM_BUILD_APP_GRASP_SERVER_TEST)

	#TARGET_LINK_LIBRARIES(GolemGraspServer GolemInteropContact GolemInteropPCL)
	TARGET_LINK_LIBRARIES(GolemGraspServer
		${Boost_LIBRARIES}
		${PCL_LIBRARIES}
	)
	if (UNIX)
		TARGET_LINK_LIBRARIES(GolemGraspServer ${CMAKE_DL_LIBS})
	endif ()
	if(NOT GOLEM_BUILD_APP_GRASP_SERVER_TEST)
		TARGET_LINK_LIBRARIES(GolemGraspServer
			${OpenCV_LIBS}
			extern
		)
		if (UNIX)
			#TARGET_LINK_LIBRARIES(GolemGraspServer)
		endif ()
	endif(NOT GOLEM_BUILD_APP_GRASP_SERVER_TEST)
	
	COPY_FILES(GolemGraspServer ${RUNTIME_OUTPUT_DIRECTORY} ${PACKAGE_FILES})
	SET_PROPERTY(TARGET GolemGraspServer PROPERTY RELEASE_POSTFIX ${CMAKE_RELEASE_POSTFIX})
	SET_PROPERTY(TARGET GolemGraspServer PROPERTY DEBUG_POSTFIX ${CMAKE_DEBUG_POSTFIX})
	
	if (CPACK_BUILD_CORE)
		INSTALL(TARGETS GolemGraspServer RUNTIME DESTINATION bin COMPONENT app_execs)
		INSTALL(FILES ${PACKAGE_HEADERS} DESTINATION include/Golem/Interop/GraspServer/ COMPONENT app_headers)
		INSTALL(FILES ${PACKAGE_FILES} DESTINATION bin COMPONENT app_configs)
	endif (CPACK_BUILD_CORE)

	SET_PROPERTY(TARGET GolemGraspServer PROPERTY PROJECT_LABEL "GraspServer")
	SET_PROPERTY(TARGET GolemGraspServer PROPERTY FOLDER "App/Interop")
	SOURCE_GROUP("Include Files" FILES ${PACKAGE_HEADERS})
	SOURCE_GROUP("Resource Files" FILES ${PACKAGE_FILES})
endif(GOLEM_BUILD_APP_GRASP_SERVER)
