###############################################################################
#
# Golem App/Interop/Part3DHoPViewServer application
#
###############################################################################

option(GOLEM_BUILD_APP_PART3DHOPVIEWSERVER "Build Interop Part3DHoPViewServer application" NO)
mark_as_advanced(GOLEM_BUILD_APP_PART3DHOPVIEWSERVER)

if(GOLEM_BUILD_APP_PART3DHOPVIEWSERVER)
	# HOP3D
	option(GOLEM_BUILD_APP_PART3DHOPVIEWSERVER_TEST "Build Interop Part3DHoPViewServer test without HOP3D" YES)
	mark_as_advanced(GOLEM_BUILD_APP_PART3DHOPVIEWSERVER_TEST)
	if(NOT GOLEM_BUILD_APP_PART3DHOPVIEWSERVER_TEST)
		SET(HOP3D_DIR "${GOLEM_PROJECT_PARENT}/hop3d" CACHE PATH "HOP3D directory")

		# OpenCV
		FIND_PACKAGE(OpenCV REQUIRED)
	endif(GOLEM_BUILD_APP_PART3DHOPVIEWSERVER_TEST)

	# Boost
	if (WIN32)
		ADD_DEFINITIONS(-DBOOST_ALL_NO_LIB)
		SET(Boost_USE_STATIC_LIBS ON)
		SET(Boost_ALL_DYN_LINK OFF)
	elseif (UNIX)
		#ADD_DEFINITIONS(-DBOOST_ALL_NO_LIB)
		#SET(Boost_USE_STATIC_LIBS OFF)
		#SET(Boost_ALL_DYN_LINK ON)
	endif ()
	FIND_PACKAGE(Boost COMPONENTS system)
	
	# PCL
	FIND_PACKAGE(PCL REQUIRED)
	list(REMOVE_ITEM PCL_LIBRARIES "vtkproj4") # PCL bug

	
	SET(PACKAGE_DIR "${PACKAGE_APP}/Interop/Part3DHoPViewServer")

	FILE(GLOB_RECURSE PACKAGE_SOURCES "${PACKAGE_DIR}/src/*.cpp")
	FILE(GLOB_RECURSE PACKAGE_HEADERS "${PACKAGE_DIR}/include/*.h")
	FILE(GLOB_RECURSE PACKAGE_FILES "${PACKAGE_DIR}/resources/*.xml")

	ADD_EXECUTABLE(GolemPart3DHoPViewServer ${PACKAGE_SOURCES} ${PACKAGE_HEADERS} ${PACKAGE_FILES})

	if (WIN32)
		TARGET_COMPILE_OPTIONS(GolemPart3DHoPViewServer PUBLIC /wd4996 /wd4005)
	elseif (UNIX)
		TARGET_COMPILE_OPTIONS(GolemPart3DHoPViewServer PUBLIC -Wno-invalid-offsetof)
	endif()

	if(NOT GOLEM_BUILD_APP_PART3DHOPVIEWSERVER_TEST)
		TARGET_COMPILE_DEFINITIONS(GolemPart3DHoPViewServer
			PUBLIC _HOP3D_LIB_=1
			PUBLIC ${OPENCV_DEFINITIONS}
		)
	endif(GOLEM_BUILD_APP_PART3DHOPVIEWSERVER_TEST)
	
	#TARGET_INCLUDE_DIRECTORIES(GolemPart3DHoPViewServer PUBLIC ${PACKAGE_DIR}/include ${GOLEM_PROJECT_PACKAGES}/Plugin/Data/Part3DHoP/include)
	TARGET_INCLUDE_DIRECTORIES(GolemPart3DHoPViewServer
		PUBLIC ${PACKAGE_DIR}/include
		PUBLIC ${GOLEM_PROJECT_PACKAGES}/Plugin/Data/Part3DHoP/include
		PUBLIC ${GOLEM_PROJECT_PACKAGES}/Interop/Interop/Core/include/Golem/Interop
		PUBLIC ${GOLEM_PROJECT_PACKAGES}/Interop/Interop/PCL/include/Golem/Interop
		PUBLIC ${Boost_INCLUDE_DIRS}
		PUBLIC ${PCL_INCLUDE_DIRS}
	)
	if(NOT GOLEM_BUILD_APP_PART3DHOPVIEWSERVER_TEST)
		TARGET_INCLUDE_DIRECTORIES(GolemPart3DHoPViewServer
			PUBLIC ${OPENCV_INCLUDE_DIRS}
			PUBLIC ${HOP3D_DIR}/include
			PUBLIC ${HOP3D_DIR}/external/octree
			PUBLIC ${HOP3D_DIR}/external/tinyXML
		)
	endif(GOLEM_BUILD_APP_PART3DHOPVIEWSERVER_TEST)

	#TARGET_LINK_LIBRARIES(GolemPart3DHoPViewServer GolemInteropCore GolemInteropPCL)
	TARGET_LINK_LIBRARIES(GolemPart3DHoPViewServer
		${Boost_LIBRARIES}
		${PCL_LIBRARIES}
	)
	if (UNIX)
		TARGET_LINK_LIBRARIES(GolemPart3DHoPViewServer ${CMAKE_DL_LIBS})
	endif ()
	if(NOT GOLEM_BUILD_APP_PART3DHOPVIEWSERVER_TEST)
		TARGET_LINK_LIBRARIES(GolemPart3DHoPViewServer
			${OpenCV_LIBS}
			hop3d hop3dDataset hop3dStatisticsBuilder hop3dObjectComposition hop3dImageFilter hop3dUtilities hop3dData hop3dPartSelector tinyxml2
		)
		if (UNIX)
			TARGET_LINK_LIBRARIES(GolemPart3DHoPViewServer gomp)
		endif ()
	endif(GOLEM_BUILD_APP_PART3DHOPVIEWSERVER_TEST)
	
	COPY_FILES(GolemPart3DHoPViewServer ${RUNTIME_OUTPUT_DIRECTORY} ${PACKAGE_FILES})
	SET_PROPERTY(TARGET GolemPart3DHoPViewServer PROPERTY RELEASE_POSTFIX ${CMAKE_RELEASE_POSTFIX})
	SET_PROPERTY(TARGET GolemPart3DHoPViewServer PROPERTY DEBUG_POSTFIX ${CMAKE_DEBUG_POSTFIX})
	
	if (CPACK_BUILD_CORE)
		INSTALL(TARGETS GolemPart3DHoPViewServer RUNTIME DESTINATION bin COMPONENT app_execs)
		INSTALL(FILES ${PACKAGE_HEADERS} DESTINATION include/Golem/Interop/Part3DHoPViewServer/ COMPONENT app_headers)
		INSTALL(FILES ${PACKAGE_FILES} DESTINATION bin COMPONENT app_configs)
	endif (CPACK_BUILD_CORE)

	SET_PROPERTY(TARGET GolemPart3DHoPViewServer PROPERTY PROJECT_LABEL "Part3DHoPViewServer")
	SET_PROPERTY(TARGET GolemPart3DHoPViewServer PROPERTY FOLDER "App/Interop")
	SOURCE_GROUP("Include Files" FILES ${PACKAGE_HEADERS})
	SOURCE_GROUP("Resource Files" FILES ${PACKAGE_FILES})
endif(GOLEM_BUILD_APP_PART3DHOPVIEWSERVER)
